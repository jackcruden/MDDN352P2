<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
        <title>Weather Lad - Your Intelligent Weather Companion</title>

		<!-- iOS Homescreen -->
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-title" content="Weather Lad">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="viewport" content="initial-scale=1,user-scalable=no">
        <meta name="format-detection" content="telephone=no">
        <link rel="apple-touch-icon" href="images/logo.png">

        <!-- Favicon -->
        <link rel="icon" href="images/logo.png">

        <!-- Style -->
        <link rel="stylesheet" href="css/style.css">

        <!-- Bootstrap -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

        <!-- Google Fonts -->
        <link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Montserrat:700,400' rel='stylesheet' type='text/css'>

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
          <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
          <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>

    <body>
        <div class="day">
            <div class="container">
                <div class="row">
                    <div class="col-sm-4 col-lg-3">
                        <div class="col-xs-5">
                            <img id="day1Icon" src="images/gifs/sun.gif">
                        </div>
                        <div class="col-xs-7">
                            <span id="day1Day" class="dayOfWeek">Day</span>
                            <div class="row">
                                <div class="col-xs-6">
                                    <span id="day1High" class="high">H</span>
                                    <small class="tempLabel">HIGH</small>
                                </div>
                                <div class="col-xs-6">
                                    <span id="day1Low" class="low">L</span>
                                    <small class="tempLabel">LOW</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-4 col-lg-3 hidden-xs">
                        <div class="col-xs-5">
                            <img id="day2Icon" src="images/gifs/sun.gif">
                        </div>
                        <div class="col-xs-7">
                            <span id="day2Day" class="dayOfWeek">Day</span>
                            <div class="row">
                                <div class="col-xs-6">
                                    <span id="day2High" class="high">H</span>
                                    <small class="tempLabel">HIGH</small>
                                </div>
                                <div class="col-xs-6">
                                    <span id="day2Low" class="low">L</span>
                                    <small class="tempLabel">LOW</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-4 col-lg-3 hidden-xs">
                        <div class="col-xs-5">
                            <img id="day3Icon" src="images/gifs/sun.gif">
                        </div>
                        <div class="col-xs-7">
                            <span id="day3Day" class="dayOfWeek">Day</span>
                            <div class="row">
                                <div class="col-xs-6">
                                    <span id="day3High" class="high">H</span>
                                    <small class="tempLabel">HIGH</small>
                                </div>
                                <div class="col-xs-6">
                                    <span id="day3Low" class="low">L</span>
                                    <small class="tempLabel">LOW</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-4 col-lg-3 visible-lg-block">
                        <div class="col-xs-5">
                            <img id="day4Icon" src="images/gifs/sun.gif">
                        </div>
                        <div class="col-xs-7">
                            <span id="day4Day" class="dayOfWeek">Day</span>
                            <div class="row">
                                <div class="col-xs-6">
                                    <span id="day4High" class="high">H</span>
                                    <small class="tempLabel">HIGH</small>
                                </div>
                                <div class="col-xs-6">
                                    <span id="day4Low" class="low">L</span>
                                    <small class="tempLabel">LOW</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <p id="status">Status.</p>
            </div>
        </div>

        <div id="chat">
            <div class="container">
                <div class="row">
                    <div class="col-sm-8 col-sm-offset-2">
                        <div class="speech from" id="firstMessage">
                            Hey there! Ask me about the weather tomorrow, or on Saturday...
                        </div>
                        <div id="endOfMessages"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                <div class="col-sm-8 col-sm-offset-2">
                    <div class="speech say" id="saySomething">
                        <input type="text" placeholder="Ask something...">
                    </div>
                </div>
            </div>
        </div>

        <div id="popupWeather" class="popup">
            <img src="images/gifs/cloud_rain.gif">
            Oops! There was an error while I was trying to fetch the latest weather data.
            I'll try again in a minute, but maybe check your internet connection.
        </div>
        <div id="popupLoading" class="popup">
            <img src="images/gifs/sun.gif">
            Loading location and weather data...
        </div>
        <div id="popupBlack"></div>

        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

        <!-- Moment.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>

        <!-- Bootstrap JS -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

        <script>
            // Dumb responses
            var idk = [
                "Hmm, I'm not sure how to respond.",
                "Sorry, I'm pretty dumb at the moment. I'm learning, though!",
                "Sorry, can't help you there.",
                "No idea what you just said, sorry.",
            ];

            // When the user sends a message
            $('#saySomething input').keyup(function(event) {
                // If not enter, ignore
                if (event.keyCode != 13) return;

                // Construct the speech box
                var toMessage = $('<div class="speech to"></div>');

                // Insert the user's message and clear the input box
                var query = $('#saySomething input').val();
                toMessage.html(query);
                toMessage.insertBefore($('#endOfMessages'));
                $('#saySomething input').val('');

                // Process the query
                processQuery(query);

                // Scroll to the bottom
                var scroll = $('#chat')[0].scrollHeight - $('#chat')[0].clientHeight;
                $("#chat").animate({scrollTop: scroll}, 200);
            });

            function sendMessage(message)
            {
                var fromMessage = $('<div class="speech from"></div>');
                fromMessage.html(message);
                setTimeout(function() {
                    fromMessage.insertBefore($('#endOfMessages'));
                    var scroll = $('#chat')[0].scrollHeight - $('#chat')[0].clientHeight;
                    $("#chat").animate({scrollTop: scroll}, 200);
                }, 1000);

                // Scroll to the bottom
                var scroll = $('#chat')[0].scrollHeight - $('#chat')[0].clientHeight;
                $("#chat").animate({scrollTop: scroll}, 200);
            }

            // The grand processing function
            function processQuery(q)
            {
                // Clean the query
                q = q.toLowerCase();
                q = q.split(' ');
                q.forEach(function(item, i) {
                    q[i] = item.replace(/[^a-z]/g, "");
                });
                q.join(" ");

                if (match(q, ['tomorrow'])) {
                    sendMessage(generateStatus(forecast[1]));
                } else if (match(q, days)) {
                    forecast.forEach(function(item, i) {
                        if (q.indexOf(item['day'].toLowerCase()) > -1) {
                            sendMessage(generateStatus(forecast[i]));
                            return;
                        }
                    });
                } else {
                    // Don't know
                    sendMessage(idk[Math.floor((Math.random() * idk.length) + 0)]);
                }
            }

            function match(query, words)
            {
                var contains = false;
                query.forEach(function(q, qI) {
                    words.forEach(function(w, qI) {
                        if (q.toLowerCase() == w.toLowerCase()) {
                            contains = true;
                            return;
                        }
                    });
                });

                return contains;
            }

            // ----------------------------------------------------------------------
            // Get weather data and set it on the page
            // ----------------------------------------------------------------------

            var days = [
                'Sunday',
                'Monday',
                'Tuesday',
                'Wednesday',
                'Thursday',
                'Friday',
                'Saturday'
            ];

            // Vary the wording of responses to seem less robotic
            var statusVars = [
                [
                    'Looks like it\'s',
                    'Seems to be',
                    'My sources say it\'s'
                ],
                [
                    'in',
                    'over',
                    'near'
                ],
                [
                    'at the moment',
                    'for now',
                    'today'
                ],
                [
                    'We\'ve got temperatures up to',
                    'A high of',
                    'Peaking at'
                ],
                [
                    'and down to',
                    ', with a low of',
                    'and temperatures as low as'
                ]
            ];

            var responseVars = [
                [
                    'Looks like it will be',
                    'Seems like it\'s gonna be',
                    'My sources say'
                ],
                [
                    'in',
                    'over',
                    'near'
                ],
                [

                ],
                [
                    'We\'ll have temperatures up to',
                    'A high of',
                    'Peaking at'
                ],
                [
                    'and down to',
                    ', with a low of',
                    'and temperatures as low as'
                ]
            ];

            var tempVars = [
                [
                    'Not too bad today, temperature wise.',
                    'Getting a little heat on today.',
                    'I\'d consider heading to the beach!'
                ],
                [
                    'Not the warmest day, eh.',
                    'Could definitely be warmer.',
                    'Maybe not a day for the beach.'
                ],
                [
                    'You\'ll probably be wanting a jersey out today.',
                    'Definitely take a coat out.',
                    'Layer up!'
                ]
            ];

            // Settings
            var weatherApiKey = '0f171838ffe7d226be21b8e88ebc6956';
            var googleApiKey = 'AIzaSyAWh9ksj-3PXvML9HMSgQuyNd2euwOH2lw';

            // The data variables
            var city = ''; // Wellington
            var country = ''; // NZ
            var weather = [];
            var forecast = [];

            // If Chrome, recommend Firefox
            // if (navigator.userAgent.toLowerCase().indexOf('chrome') > -1) {
            //     alert('Chrome doesn\'t allow use of the HTML5 GeoLocation API on insecure connections (http). Please use Firefox until Weather Lad is properly hosted.')
            // };
            // Check if browser supports W3C Geolocation API
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(getForecast, locationError);
            }

            // Updates current weather
            function setStatus()
            {
                console.log('setStatus()');

                var status = 'Good ' + getGreeting() + '! ';
                status += generateStatus(forecast[0], true);

                // Set the status
                $('#status').html(status);
            }

            // Set the forecast data
            function setForecast()
            {
                console.log('setForecast()');

                // For each day...
                forecast.forEach(function(item, index) {
                    if (i > 4) return;
                    var i = index + 1;

                    // Set the icons
                    var icon = 'images/gifs/' + getWeatherIcon(forecast[index]['icon']) + '.gif';
                    $('#day'+i+'Icon').attr('src', icon);

                    // Set the day
                    $('#day'+i+'Day').html(forecast[index]['day']);

                    // Set the high and the low
                    $('#day'+i+'High').html(forecast[index]['high']);
                    $('#day'+i+'Low').html(forecast[index]['low']);
                });
            }

            function getForecast(position)
            {
                console.log('getForecast()');

                // Make the URL
                url = "https://api.openweathermap.org/data/2.5/forecast/daily?lat="+position.coords.latitude+"&lon="+position.coords.longitude+"&appid=" + weatherApiKey;


                // Make the call
                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function (response) {
                        var items = response['list'];

                        items.forEach(function(item, index) {
                            // If in the past, ignore it
                            var m = moment(item['dt']*1000).utc();
                            if (m.format('X') < moment().format('X')) return;

                            var day = [];
                            day['moment'] = moment(item['dt']*1000).utc();
                            day['day'] = days[moment(item['dt']*1000).utc().day()];
                            day['icon'] = item['weather'][0]['icon'];
                            day['description'] = item['weather'][0]['description']
                            day['high'] = Math.round(item['temp']['max'] - 273.15);
                            day['low'] = Math.round(item['temp']['min'] - 273.15);

                            forecast.push(day);
                        });

                        // Set the forecast data and status
                        setForecast();
                        setStatus();

                        // Run again in an hour
                        setTimeout(getForecast, 3600000);

                        // Hide the failure dialogue
                        $('#popupWeather').hide();
                        $('#popupBlack').hide();

                        // Hide the loading dialogue
                        $('#popupLoading').hide();
                    },
                    error: function (response) {
                        // Run again in a minute
                        setTimeout(getForecast, 60000);

                        // Show a failure dialogue
                        $('#popupWeather').show();
                        $('#popupBlack').show();
                    },
                    timeout: 5000
                });
            }

            // Location error
            function locationError()
            {
                console.log('locationError()');

                // Show a failure dialogue
                $('#popupWeather').show();
                $('#popupBlack').show();
            }

            function generateStatus(day)
            {
                return generateStatus(day, false);
            }

            function generateStatus(day, s)
            {
                // If 's', update status, don't respond

                var vars = responseVars;
                if (s) vars = statusVars;

                var status = [];
                status.push(random(vars[0])); // Looks like it's
                status.push(day['description']); // cloudy
                // status.push(random(vars[1])); // in
                // status.push(city); // Wellington.
                if (s) status.push(random(vars[2])+'.'); // today.
                if (!s) {
                    status.push('on ' + day['day']+'.');
                }
                status.push(random(vars[3])); // With a high of
                status.push(day['high']);
                status.push(random(vars[4])); // and a low of
                status.push(day['low']+'.');

                if (day['high'] > 22) {
                    status.push(random(tempVars[0])); // Good day for the beach.
                } else if (day['high'] > 17) {
                    status.push(random(tempVars[1])); // Could be warmer.
                } else {
                    status.push(random(tempVars[2])); // Layer up!
                }

                status = status.join(' ');

                return status;
            }

            // Get a random array entry
            function random(items)
            {
                return items[Math.floor(Math.random()*items.length)];
            }

            // Get the time of day (afternoon, evening, morning)
            // https://gist.github.com/James1x0/8443042
            function getGreeting()
            {
                var m = moment();

                var g = null; // return g

                if(!m || !m.isValid()) { return; } //if we can't find a valid or filled moment, we return.

                var split_afternoon = 12 // 24hr time to split the afternoon
                var split_evening = 17 // 24hr time to split the evening
                var currentHour = parseFloat(m.format("HH"));

                if(currentHour >= split_afternoon && currentHour <= split_evening) {
                    g = "afternoon";
                } else if(currentHour >= split_evening) {
                    g = "evening";
                } else {
                    g = "morning";
                }

                return g;
            }

            // Get the name of the weather icon file to load
            function getWeatherIcon(iconCode)
            {
                // Translate icon code to image
                translate = [];
                translate['01'] = 'sun'; // Clear sky
                translate['02'] = 'sun_cloud'; // Few clouds
                translate['03'] = 'cloud'; // Scattered clouds
                translate['04'] = 'cloud_cloud'; // Broken clouds
                translate['09'] = 'cloud_rain'; // Shower rain
                translate['10'] = 'sun_cloud_rain'; // Rain
                translate['11'] = 'cloud_lightning'; // Thunderstorm
                translate['13'] = 'cloud_rain'; // Snow
                translate['50'] = 'cloud'; // Mist

                // Trim the code
                iconCode = iconCode.substring(0, 2);

                return translate[iconCode];
            }
        </script>

    </body>

</html>
